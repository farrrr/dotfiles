#!/usr/bin/env bash
# vim: syntax=sh

set -eufo pipefail

addFirstInPath() {
  if [ -d "$1" ] && [[ ":$PATH:" != *":$1:"* ]]; then
    PATH="$1${PATH:+":$PATH"}"
  fi
}

addLastInPath() {
  if [ -d "$1" ] && [[ ":$PATH:" != *":$1:"* ]]; then
    PATH="${PATH:+"$PATH:"}$1"
  fi
}

# Homebrew
[ -x "$(command -v brew)" ] && HOMEBREW_PREFIX=$(brew --prefix)

if [ -z "$HOMEBREW_PREFIX" ]; then
  if [ -d "/opt/homebrew" ]; then
    HOMEBREW_PREFIX="/opt/homebrew"
  elif [ -d "/home/linuxbrew/.linuxbrew" ]; then
    HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
  else
    HOMEBREW_PREFIX="/usr/local"
  fi
  export HOMEBREW_PREFIX
fi

addFirstInPath "$HOMEBREW_PREFIX/sbin"
addFirstInPath "$HOMEBREW_PREFIX/bin"

{{- $sudo := "sudo " -}}
{{- if eq .chezmoi.username "root" -}}
{{-   $sudo = "" -}}
{{- end -}}

{{- if or (eq .osid "linux-debian") (eq .osid "linux-ubuntu") }}

set +e
# ----------------- #
# APT               #
# ----------------- #

install_apt_package() {
  if [ -n "$1" ]; then
    if ! dpkg-query -l "$1" > /dev/null; then
      echo "Installing '$1' ..."
      {{ $sudo }}apt install -y "$1"
    fi
  fi
}

if ! [ -x "$(command -v add-apt-repository)" ]; then
  {{ $sudo }}apt install -y software-properties-common
fi

# add-apt-repository
{{-   range .packages.linux.aptrepo -}}
{{-     if (kindIs "string" . ) }}
{{ $sudo }}add-apt-repository -y {{ . }}
{{-     else }}
{{ $sudo }}apt-key adv --keyserver {{ .keyserver }} --recv-key {{ .recvkey }}
{{ $sudo }}apt-add-repository -y {{ .repo }}
{{-     end }}
{{-   end }}

# update apt & full-upgrade
{{ $sudo }}apt update
{{ $sudo }}apt full-upgrade -y

{{    range .packages.linux.apt -}}
install_apt_package {{ . }}
{{    end -}}

{{    if eq .chezmoi.arch "amd64" -}}
# ----------------- #
# Homebrew          #
# ----------------- #
{{      template "homebrew" dict "packages" .packages.linux "os" .chezmoi.os }}
{{-   end }}

set -e

{{ $sudo }}apt autoremove --yes
{{- end -}}
